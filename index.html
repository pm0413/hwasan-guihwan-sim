<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í™”ì‚°ê·€í™˜ ë°©ì¹˜í˜• ì‹œë®¬ë ˆì´í„°</title>
    <style>
        /* ================= 1. í°íŠ¸ ì„¤ì • (ì¡°ì„ êµ¬êµ´ë¦¼) ================= */
        @font-face {
            font-family: 'JoseonGulim';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@1.0/ChosunGu.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        /* ================= CSS ë³€ìˆ˜ ================= */
        :root {
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --bg-header: #ffffff;
            --text-primary: #333333;
            --text-secondary: #555555;
            --border-color: #ddd;
            --accent-color: #4CAF50;
            --log-bg: #2c3e50;
            --log-text: #ecf0f1;
            --card-bg: #fafafa;
        }

        body.dark-theme {
            --bg-body: #121212;
            --bg-panel: #1e1e1e;
            --bg-header: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --border-color: #333;
            --accent-color: #66bb6a;
            --log-bg: #121212;
            --log-text: #cfd8dc;
            --card-bg: #2c2c2c;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        *::-webkit-scrollbar {
            display: none;
        }

        /* ================= ê¸°ë³¸ ìŠ¤íƒ€ì¼ ================= */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'JoseonGulim', sans-serif;
            /* í°íŠ¸ ì ìš© */
            height: 100vh;
            overflow: hidden;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 20;
        }

        .game-header h1 {
            font-size: 1.25rem;
            margin: 0;
            letter-spacing: -1px;
        }

        #theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 5px 12px;
            cursor: pointer;
            border-radius: 15px;
            font-family: 'JoseonGulim';
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .game-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* íŒ¨ë„ ê³µí†µ */
        .panel {
            padding: 15px;
            border-right: 1px solid var(--border-color);
            background-color: var(--bg-panel);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .panel h2 {
            font-size: 1.0rem;
            margin: 0;
        }

        /* --- [ì™¼ìª½] ìºë¦­í„° ì •ë³´ íŒ¨ë„ --- */
        .left-panel {
            width: 320px;
            flex-shrink: 0;
            z-index: 15;
        }

        .panel-body-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .char-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .char-select-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-panel);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
            font-family: 'JoseonGulim';
            font-size: 0.9rem;
        }

        .char-select-btn.active {
            background: #333;
            color: #fff;
        }

        .sub-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }

        .sub-tab-btn {
            flex: 1;
            padding: 8px 0;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: 'JoseonGulim';
        }

        .sub-tab-btn.active {
            border-bottom-color: var(--accent-color);
            color: var(--text-primary);
            font-weight: bold;
        }

        .info-content {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* ì •ë³´ í‘œì‹œìš© ìŠ¤íƒ€ì¼ */
        .info-box {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .info-label {
            display: block;
            font-weight: bold;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .quote-text {
            font-style: italic;
            color: var(--text-primary);
            border-left: 3px solid var(--accent-color);
            padding-left: 8px;
        }

        .item-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #eee;
            border-radius: 15px;
            font-size: 0.85rem;
            margin: 2px;
            color: #333;
            border: 1px solid #ddd;
        }

        .rel-card {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        #mobile-toggle-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* --- [ì¤‘ì•™] ê²Œì„ í™”ë©´ --- */
        .center-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
            padding: 0;
            background-color: #000;
        }

        /* ê¸°ë³¸ ë°°ê²½ì„ ë´„ ì´ë¯¸ì§€ë¡œ ì„¤ì • */
        #game-bg {
            width: 100%;
            height: 100%;
            background-image: url('bg/spring.jpg');
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            transition: filter 2s ease;
            /* ê³„ì ˆ ë³€ê²½ ì‹œ ë¶€ë“œëŸ½ê²Œ ìƒ‰ê° ì „í™˜ */
        }

        .character-sprite {
            width: 140px;
            height: auto;
            position: absolute;
            z-index: 10;
            transform: translate(-50%, -50%);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .character-sprite img {
            width: 100%;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.5));
            transition: transform 0.2s;
        }

        .character-sprite.walking img {
            animation: hop 0.5s infinite alternate ease-in-out;
        }

        @keyframes hop {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-6px);
            }
        }

        .bubble {
            background: white;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 13px;
            position: absolute;
            bottom: 100%;
            margin-bottom: 8px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 2px solid #ddd;
            color: #333;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .bubble.show {
            opacity: 1;
        }

        /* --- [ì˜¤ë¥¸ìª½] ë¡œê·¸ì°½ (ì¹´ë“œ ìŠ¤íƒ€ì¼ - PC ì ìš©) --- */
        .right-panel {
            width: 300px;
            flex-shrink: 0;
            border-right: none;
            /* ë°°ê²½ìƒ‰ì„ íŒ¨ë„ìƒ‰(ë°ì€ìƒ‰/ë‹¤í¬ëª¨ë“œ)ìœ¼ë¡œ í†µì¼ */
            background-color: var(--bg-panel);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        /* ì‹œê°„/ê³„ì ˆ í‘œì‹œ í—¤ë” */
        #season-header {
            padding: 10px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
        }

        /* ë¡œê·¸ ì»¨í…Œì´ë„ˆ */
        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            /* PCì—ì„œë„ ì¹´ë“œ ë°°ê²½ê³¼ êµ¬ë¶„ë˜ë„ë¡ ë°”ë”” ë°°ê²½ìƒ‰ ì‚¬ìš© */
            background-color: var(--bg-body);
            display: flex;
            flex-direction: column-reverse;
            /* ìµœì‹  ë¡œê·¸ê°€ ìœ„ë¡œ */
            font-family: 'JoseonGulim', monospace;
        }

        /* ê°œë³„ ë¡œê·¸ ì¹´ë“œ (ê³µí†µ ë””ìì¸) */
        .log-entry {
            padding: 6px 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.72rem;
            line-height: 1.4;

            /* ì¹´ë“œ ìŠ¤íƒ€ì¼ í•µì‹¬ */
            background: var(--bg-panel);
            border-left: 4px solid #ccc;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            color: var(--text-primary);
        }

        .log-entry:hover {
            transform: translateX(2px);
        }

        /* ì‹œê°„ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .log-time {
            display: block;
            /* [í•µì‹¬] ì‹œê°„ì„ ë¸”ë¡ ìš”ì†Œë¡œ ë§Œë“¤ì–´ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ */
            margin-bottom: 5px;
            /* ë‚´ìš©ê³¼ ì‹œê°„ ì‚¬ì´ì˜ ê°„ê²© ì¶”ê°€ */
            color: #aaa;
            /* ìƒ‰ìƒì„ ì¡°ê¸ˆ ë” ì—°í•˜ê²Œ */
            font-size: 0.7rem;
            font-weight: normal;
            letter-spacing: -0.5px;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
            /* (ì„ íƒ) ì‹œê°„ ì•„ë˜ ì•„ì£¼ ì—°í•œ êµ¬ë¶„ì„  */
            padding-bottom: 3px;
        }

        /* === ìƒí™©ë³„ ì»¬ëŸ¬ ìŠ¤íƒ€ì¼ === */
        /* 1. ëŒ€í™”/ìƒí˜¸ì‘ìš© (íŒŒë€ìƒ‰) */
        .log-social {
            border-left-color: #2196f3;
            background: rgba(33, 150, 243, 0.05);
        }

        /* 2. ì‹œìŠ¤í…œ/ë…ë°± (íšŒìƒ‰) */
        .log-system {
            border-left-color: #9e9e9e;
        }

        /* 3. ë‚ ì§œ ë³€ê²½ (íŠ¹ìˆ˜) */
        .log-date {
            border: none;
            background: none;
            box-shadow: none;
            text-align: center;
            padding: 15px 0;
            color: var(--text-secondary);
        }

        /* ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ */
        body.dark-theme .log-social {
            background: rgba(33, 150, 243, 0.15);
        }

        body.dark-theme .log-entry {
            box-shadow: none;
            border-bottom: 1px solid #333;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media screen and (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 10px 15px;
                height: auto;
                transition: max-height 0.3s ease-out;
            }

            .panel-body-wrapper {
                max-height: 0;
                opacity: 0;
                transition: all 0.3s ease-out;
            }

            .left-panel.open .panel-body-wrapper {
                max-height: 60vh;
                opacity: 1;
                margin-top: 10px;
            }

            #mobile-toggle-btn {
                display: block;
            }

            .center-panel {
                width: 100%;
                flex: 1;
                border-right: none;
            }

            /* --- [ì˜¤ë¥¸ìª½] ë¡œê·¸ì°½ (ì¹´ë“œ ìŠ¤íƒ€ì¼ ì ìš©) --- */
            .right-panel {
                width: 100%;
                height: 250px;
                min-height: 250px;
                border-top: 1px solid var(--border-color);
                background-color: var(--bg-panel);
                /* ë°°ê²½ìƒ‰ì„ íŒ¨ë„ìƒ‰ê³¼ í†µì¼ */
                display: flex;
                flex-direction: column;
            }

            /* ë¡œê·¸ê°€ ìŒ“ì´ëŠ” ë°•ìŠ¤ */
            .log-container {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
                background-color: var(--bg-body);
                /* ì•½ê°„ ì–´ë‘ìš´ ë°°ê²½ */
                display: flex;
                flex-direction: column-reverse;
                /* ìµœì‹  ë¡œê·¸ê°€ ìœ„ë¡œ */
            }

            /* ê°œë³„ ë¡œê·¸ ì¹´ë“œ (ê³µí†µ ë””ìì¸) */
            .log-entry {
                padding: 6px 8px;
                margin-bottom: 5px;
                border-radius: 4px;
                font-size: 0.8rem;
                line-height: 1.4;
                background: var(--bg-panel);
                /* ì¹´ë“œ ë°°ê²½ìƒ‰ */
                border-left: 4px solid #ccc;
                /* ê¸°ë³¸ ì™¼ìª½ ë  ìƒ‰ìƒ */
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                /* ì‚´ì§ ê·¸ë¦¼ì */
                transition: transform 0.2s;
                color: var(--text-primary);
            }

            .log-entry:hover {
                transform: translateX(2px);
            }

            /* [ìˆ˜ì •] ëª¨ë°”ì¼ì—ì„œëŠ” ì‹œê°„ê³¼ ë‚´ìš©ì„ í•œ ì¤„ë¡œ í‘œì‹œ */
            .log-time {
                display: inline-block !important;
                /* ê°•ì œë¡œ ì¸ë¼ì¸ ë¸”ë¡ */
                margin-bottom: 0 !important;
                /* ì•„ë˜ ì—¬ë°± ì œê±° */
                margin-right: 6px;
                /* ì˜¤ë¥¸ìª½ ì—¬ë°± ì¶”ê°€ */
                border-bottom: none !important;
                /* êµ¬ë¶„ì„  ì œê±° */
                padding-bottom: 0 !important;
            }

            /* === ìƒí™©ë³„ ì»¬ëŸ¬ ìŠ¤íƒ€ì¼ (ë³´ë‚´ì£¼ì‹  íŒŒì¼ ì°¸ê³ ) === */

            /* 1. ëŒ€í™”/ìƒí˜¸ì‘ìš© (íŒŒë€ìƒ‰ ê³„ì—´) */
            .log-social {
                border-left-color: #2196f3;
                background: rgba(33, 150, 243, 0.05);
                /* ì•„ì£¼ ì—°í•œ íŒŒë‘ ë°°ê²½ */
            }

            /* 2. ì‹œìŠ¤í…œ/ë…ë°± (íšŒìƒ‰/ê¸°ë³¸) */
            .log-system {
                border-left-color: #9e9e9e;
            }

            /* 3. ë‚ ì§œ ë³€ê²½ (íŠ¹ìˆ˜) */
            .log-date {
                border: none;
                background: none;
                box-shadow: none;
                text-align: center;
                padding: 15px 0;
                color: var(--text-secondary);
            }

            /* ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ (ë°°ê²½ìƒ‰ì´ ë„ˆë¬´ ë°ì§€ ì•Šê²Œ ì¡°ì •) */
            body.dark-theme .log-social {
                background: rgba(33, 150, 243, 0.15);
            }

            body.dark-theme .log-entry {
                box-shadow: none;
                border-bottom: 1px solid #333;
            }
        }


        /* ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .save-btn {
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-family: 'JoseonGulim';
            font-size: 1rem;
            cursor: pointer;
        }

        .save-btn:hover {
            opacity: 0.9;
        }


        .custom-select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-body);
            color: var(--text-primary);
            font-family: 'JoseonGulim';
            margin-top: 5px;
        }
        
        /* [1] ìŠ¤í˜ì…œ ì´ë²¤íŠ¸ íŒì—… */
        #event-popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0, 0, 0, 0.9);
            color: #FFD700;
            padding: 20px 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            border: 2px solid #FFC107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
            transition: all 0.3s ease;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #event-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        #event-popup h2 { margin: 0 0 10px 0; font-size: 1.5rem; }
        #event-popup p { margin: 0; color: #fff; font-size: 1rem; }

        /* [2] í™©ê¸ˆìƒ‰ ë¡œê·¸ */
        .log-special {
            background-color: #fff8e1 !important;
            border-left: 4px solid #FFC107 !important;
            color: #5d4037 !important;
            font-weight: bold;
        }
        body.dark-theme .log-special { background-color: #4e342e !important; color: #ffecb3 !important; }

        /* [3] ì»¤ìŠ¤í…€ ë§í’ì„  (ê¸°ì¡´ .bubble ëŒ€ì²´) */
        .char-bubble {
            position: absolute;
            bottom: 110%; left: 50%;
            transform: translateX(-50%);
            background: var(--bubble-bg, #ffffff); /* JSì—ì„œ ìƒ‰ìƒ ì£¼ì… */
            color: var(--bubble-text, #000000);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            pointer-events: none;
            transition: opacity 0.3s;
            font-weight: bold;
            opacity: 0;
        }
        .char-bubble.show { opacity: 1; }

        /* ë§í’ì„  ê¼¬ë¦¬ */
        .char-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%;
            transform: translateX(-50%);
            border-width: 8px 6px 0 6px; border-style: solid;
            border-color: var(--bubble-bg, #ffffff) transparent transparent transparent;
        }

        /* [ë‹¹ë³´ìš© ìŠ¤íƒ€ì¼] ë†’ê²Œ, ì™¼ìª½ìœ¼ë¡œ ì¹˜ìš°ì¹¨ */
        .char-bubble.pos-high {
            bottom: 100%; 
            transform: translateX(-80%) !important; /* ì™¼ìª½ìœ¼ë¡œ ë°€ê¸° */
            border-bottom-right-radius: 0;
        }
        .char-bubble.pos-high::after { left: 80%; }

        /* [ì²­ëª…ìš© ìŠ¤íƒ€ì¼] ë‚®ê²Œ, ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì¹˜ìš°ì¹¨ */
        .char-bubble.pos-low {
            bottom: 100%;
            transform: translateX(-20%) !important; /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ê¸° */
            border-bottom-left-radius: 0;
        }
        .char-bubble.pos-low::after { left: 20%; }
        
    </style>
</head>

<body>

    <header class="game-header">
        <h1>ë°©ì¹˜í˜• ì‹œë®¬ë ˆì´í„°</h1>
        <button id="theme-toggle">ğŸŒ™</button>
    </header>

    <main class="main-content">
        <div class="game-container">

            <div class="panel left-panel" id="info-panel">
                <div class="panel-header">
                    <h2>ì •ë³´ í™•ì¸</h2>
                    <button id="mobile-toggle-btn" onclick="toggleInfoPanel()">â–¼</button>
                </div>

                <div class="panel-body-wrapper">
                    <div class="char-selector">
                        <button class="char-select-btn active" id="btn-dangbo" onclick="selectCharacter('dangbo')">ë‹¹ë³´</button>
                        <button class="char-select-btn" id="btn-chung" onclick="selectCharacter('chung')">ì²­ëª…</button>
                    </div>

                    <div class="sub-tabs">
                        <button class="sub-tab-btn active" onclick="switchTab('profile')">í”„ë¡œí•„</button>
                        <button class="sub-tab-btn" onclick="switchTab('inventory')">ì†Œì§€í’ˆ</button>
                        <button class="sub-tab-btn" onclick="switchTab('relation')">ê´€ê³„</button>
                    </div>

                    <div class="info-content" id="info-display-area"></div>
                </div>
            </div>

            <div class="panel center-panel" id="game-stage">
                <div id="game-bg"></div>
            </div>

            <div class="panel right-panel">
                <div class="panel-header">
                    <h2 id="log-header-text">ê¸°ë¡</h2>
                </div>

                <div class="log-container" id="log-box">
                    <div class="log-entry">[ì‹œìŠ¤í…œ] ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</div>
                </div>
            </div>

        </div>
        
        <div id="event-popup">
        <h2 id="popup-title">ì´ë²¤íŠ¸ ì œëª©</h2>
        <p id="popup-desc">ì´ë²¤íŠ¸ ë‚´ìš©</p>
    </div>
    </main>

    <script>
        // ================= ë°ì´í„° =================
        const charData = {
            'dangbo': {
                name: "ë‹¹ë³´",
                title: "ì•”ì¡´(æš—å°Š)",
                gender: "ë‚¨ì„±", // ê¸°ë³¸ê°’: ë‚¨ì„±
                trait: "ëŠ¥ê¸€ë§ìŒ", // ê¸°ë³¸ê°’: ëŠ¥ê¸€ë§ìŒ
                inventory: ["ë¹„ë„ x12", "ë…ë³‘", "ìµœê³ ê¸‰ ìˆ "],
                relations: [{
                    target: "ì²­ëª…",
                    rel: "ì˜í˜•ì œ",
                    desc: "í‰ìƒì„ ë”°ë¥¼ ì£¼êµ°ì´ì í˜•ë‹˜."
                }],
                img: "character/ë‹¹ë³´.png",
                color: "#4CAF50",
                x: 30,
                y: 60
            },
            'chung': {
                name: "ì²­ëª…",
                title: "ë§¤í™”ê²€ì¡´(æ¢…èŠ±åŠå°Š)",
                gender: "ë‚¨ì„±", // ê¸°ë³¸ê°’: ë‚¨ì„±
                trait: "ë¬´ë˜í•¨", // ê¸°ë³¸ê°’: ë¬´ë˜í•¨
                inventory: ["ë§¤í™”ê²€", "ë‹¹ê³¼", "êµ°ë§Œë‘"],
                relations: [{
                    target: "ë‹¹ë³´",
                    rel: "ì˜í˜•ì œ",
                    desc: "ê·€ì°®ì§€ë§Œ ë¯¿ìŒì§í•œ ë…€ì„."
                }],
                img: "character/ì²­ëª….png",
                color: "#F44336",
                x: 70,
                y: 60
            }
        };

        // ì„±ê²© ëª©ë¡ (ë‚˜ì¤‘ì— ì—¬ê¸°ì— "ì§‘ì°©í•¨" ë“±ì„ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤)
        const personalityList = ["ëŠ¥ê¸€ë§ìŒ", "ë¬´ë˜í•¨", "ì§ˆíˆ¬ë§ìŒ"];

        const dialogDB = {
            // 1. ëŠ¥ê¸€ë§ìŒ (ë‹¹ë³´ ê¸°ë³¸ ì„±ê²©)
            "ëŠ¥ê¸€ë§ìŒ": [{
                    t1: "{í˜¸ì¹­}, ìˆ ë§›ì´ ì•„ì£¼ ì¢‹ìŠµë‹ˆë‹¤!",
                    t2: "ì‹œë„ëŸ¬, ì”ì´ë‚˜ ì±„ì›Œ.",
                    log: "ìˆ ì„ ë‚˜ëˆ  ë§ˆì‹­ë‹ˆë‹¤."
                },
                {
                    t1: "ìš”ì¦˜ í™”ì‚° ë†ˆë“¤ì€ ì•½í•´ë¹ ì¡ŒìŠµë‹ˆë‹¤.",
                    t2: "ë„¤ê°€ ì¢€ êµ´ë ¤ë¼.",
                    log: "í›„ê¸°ì§€ìˆ˜ ë’·ë‹´í™”ë¥¼ í•©ë‹ˆë‹¤."
                },
                {
                    t1: "{í˜¸ì¹­}, ì €ë‘ ë¹„ë¬´ë‚˜ í•œ íŒ?",
                    t2: "ëŒ€ê°€ë¦¬ ê¹¨ì§€ê³  ì‹¶ëƒ?",
                    log: "ë¹„ë¬´ë¥¼ ì œì•ˆí–ˆë‹¤ê°€ ê±°ì ˆë‹¹í•©ë‹ˆë‹¤."
                },
                {
                    t1: "ì‚¬ì²œë‹¹ê°€ë¡œ ë†€ëŸ¬ ì˜¤ì‹­ì‡¼.",
                    t2: "ë¨¹ì„ ê±° ìˆëƒ?",
                    log: "ë‹¹ê°€ ë°©ë¬¸ì„ ê¶Œìœ í•©ë‹ˆë‹¤."
                }
            ],

            // 2. ë¬´ë˜í•¨ (ì²­ëª… ê¸°ë³¸ ì„±ê²© - ë‹¹ë³´ê°€ ë¬´ë˜í•  ë•Œì˜ ëŒ€ì‚¬ ì˜ˆì‹œ)
            "ë¬´ë˜í•¨": [{
                    t1: "{í˜¸ì¹­}, ë‚ ì”¨ê°€ ì¢‹ë„¤ìš”.",
                    t2: "ê·¸ëŸ¬ê²Œ ë§ì´ë‹¤.",
                    log: "í•¨ê»˜ í•˜ëŠ˜ì„ ë°”ë¼ë´…ë‹ˆë‹¤."
                },
                {
                    t1: "ìˆ˜ë ¨ì€ ì˜ ë¼ê°€ì‹­ë‹ˆê¹Œ?",
                    t2: "ê·¸ëƒ¥ í•˜ëŠ” ê±°ì§€ ë­.",
                    log: "ìˆ˜ë ¨ ì´ì•¼ê¸°ë¥¼ í•©ë‹ˆë‹¤."
                }
            ],

            // 3. ì§ˆíˆ¬ë§ìŒ (ìƒˆë¡œ ì¶”ê°€ëœ ì„±ê²©)
            "ì§ˆíˆ¬ë§ìŒ": [{
                    t1: "{í˜¸ì¹­}, ì•„ê¹Œ ê·¸ë†ˆ ëˆ„êµ½ë‹ˆê¹Œ?",
                    t2: "ì§€ë‚˜ê°€ëŠ” ê°œë‹¤.",
                    log: "ì§ˆíˆ¬ë¥¼ í•©ë‹ˆë‹¤."
                },
                {
                    t1: "ì €ë§Œ ë³´ì‹­ì‡¼, {í˜¸ì¹­}.",
                    t2: "ì§•ê·¸ëŸ½ê²Œ ì™œ ì´ë˜?",
                    log: "ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ëˆˆë¹›ì„ ë³´ëƒ…ë‹ˆë‹¤."
                }
            ],

            // 4. ê³„ì ˆ ëŒ€ì‚¬ (ì„±ê²© ë¬´ê´€ ê³µí†µ)
            "season": {
                spring: [{
                    t1: "ë§¤í™”ê°€ íë“œëŸ¬ì§€ê²Œ íˆìŠµë‹ˆë‹¤, {í˜¸ì¹­}.",
                    t2: "ìˆ ë§› ë‹ìš°ëŠ”êµ°.",
                    log: "ê½ƒêµ¬ê²½ì„ í•˜ë©° ìˆ ì„ ë§ˆì‹­ë‹ˆë‹¤."
                }],
                summer: [{
                    t1: "ë”ì›Œ ì£½ê² ìŠµë‹ˆë‹¤... í—¥í—¥.",
                    t2: "ë„ì‚¬ê°€ ë”ìœ„ë¥¼ íƒ€ì„œì•¼ ì›.",
                    log: "ë¬´ë”ìœ„ì— ì§€ì³ê°‘ë‹ˆë‹¤."
                }],
                autumn: [{
                    t1: "ë‚™ì—½ì´ ì§€ë‹ˆ ì“¸ì“¸í•˜êµ°ìš”.",
                    t2: "ì²­ìŠ¹ ë–¨ì§€ ë§ˆë¼.",
                    log: "ê°€ì„ íƒ€ëŠ” ì¤‘ì…ë‹ˆë‹¤."
                }],
                winter: [{
                    t1: "ìˆ ì´ ì–¼ê² ìŠµë‹ˆë‹¤, {í˜¸ì¹­}.",
                    t2: "ë°ì›Œ ë§ˆì‹œë©´ ê·¸ë§Œì´ë‹¤.",
                    log: "ì¶”ìœ„ë¥¼ ìˆ ë¡œ ë‹¬ë©ë‹ˆë‹¤."
                }]
            },

            // 5. í˜¼ì£ë§
            solo: {
                dangbo: ["{í˜¸ì¹­}ì€ ì˜¤ëŠ˜ë„ ê¸°ìš´ì´ ë„˜ì¹˜ì‹œëŠ”êµ°.", "ë…ì„ ì¢€ ë” ê°œëŸ‰í•´ë³¼ê¹Œ...", "ë¹„ë„ ë‹¦ê¸° ì¢‹ì€ ë‚ ì”¨ë‹¤."],
                chung: ["ì•„ì˜¤, ì‚­ì‹ ì´ì•¼.", "ë‹¹ê³¼ê°€ ë‹¤ ë–¨ì–´ì¡ŒëŠ”ë°...", "ìˆ  ê°€ì ¸ì™€, ìˆ !"]
            },

            // 4. ìœ ëŒ ì‹œìŠ¤í…œ ì „ìš© (ë‚˜ì¤‘ì— ìœ ëŒ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ì‚¬ìš©)
            travel: [{
                    log: "ë‘ ì‚¬ëŒì´ ê°•í˜¸í–‰ì„ ë– ë‚©ë‹ˆë‹¤. (ìœ ëŒ ì¤‘)"
                },
                {
                    log: "ìœ ëª…í•œ ê°ì”ì—ì„œ êµ­ìˆ˜ë¥¼ ì‚¬ ë¨¹ìŠµë‹ˆë‹¤. (ìœ ëŒ ì¤‘)"
                },
                {
                    log: "ì‚°ì  ë–¼ë¥¼ ë§Œë‚¬ì§€ë§Œ ê°€ë³ê²Œ ì†ë´ì¤ë‹ˆë‹¤. (ìœ ëŒ ì¤‘)"
                },
                {
                    log: "ê²½ì¹˜ ì¢‹ì€ ì •ìì—ì„œ ë‚®ì ì„ ì¡ë‹ˆë‹¤. (ìœ ëŒ ì¤‘)"
                },
                {
                    log: "ì‚¬ì²œë‹¹ê°€ì— ë“¤ëŸ¬ ë…ì„ ë³´ì¶©í•©ë‹ˆë‹¤. (ìœ ëŒ ì¤‘)"
                }
            ]
        };

        let currentUserId = 'dangbo';
        let currentTab = 'profile';
        let isInteracting = false;

        // ================= ì‹œê°„ ì‹œìŠ¤í…œ (1ê³„ì ˆ = 1ì‹œê°„) =================
        // 1ê³„ì ˆ = 3ë‹¬ = 90ì¼
        const DAY_IN_MS = 300000; // 5ë¶„

        // ì €ì¥ëœ ë‚ ì§œê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ 3ì›” 1ì¼ë¡œ ì‹œì‘
        let gameDate = JSON.parse(localStorage.getItem('savedGameDate')) || {
            month: 3,
            day: 1
        };
        let lastTimeCheck = Date.now();

        // ê³„ì ˆ ì •ë³´
        const seasonInfo = {
            spring: {
                name: "ë´„",
                icon: "ğŸŒ¸",
                filter: "none"
            },
            summer: {
                name: "ì—¬ë¦„",
                icon: "â˜€ï¸",
                filter: "saturate(1.2) brightness(1.1)"
            },
            autumn: {
                name: "ê°€ì„",
                icon: "ğŸ",
                filter: "sepia(0.4) contrast(1.1)"
            },
            winter: {
                name: "ê²¨ìš¸",
                icon: "â„ï¸",
                filter: "brightness(0.9) hue-rotate(10deg) grayscale(0.3)"
            }
        };

        function getSeason(month) {
            if (month >= 3 && month <= 5) return 'spring';
            if (month >= 6 && month <= 8) return 'summer';
            if (month >= 9 && month <= 11) return 'autumn';
            return 'winter'; // 12, 1, 2
        }

        function updateTime() {
            const now = Date.now();

            // í•˜ë£¨ê°€ ì§€ë‚¬ëŠ”ì§€ ì²´í¬
            if (now - lastTimeCheck >= DAY_IN_MS) {
                lastTimeCheck = now; // ê¸°ì¤€ ì‹œê°„ ì¬ì„¤ì •
                advanceDay();
            }

            // [ì¶”ê°€] ë§¤ í”„ë ˆì„ë§ˆë‹¤ ì‹œê°„ì„ í™”ë©´ì— ê°±ì‹  (ì‹œê³„ê°€ íë¥´ê²Œ ë³´ì„)
            updateDateUI();

            requestAnimationFrame(updateTime);
        }

       // [ìˆ˜ì •] ë‚ ì§œ ë³€ê²½: ìŠ¤í˜ì…œ ì´ë²¤íŠ¸ ë°œë™ ì¶”ê°€
        function advanceDay() {
            gameDate.day++;
            if (gameDate.day > 30) {
                gameDate.day = 1;
                gameDate.month++;
                if (gameDate.month > 12) gameDate.month = 1;
            }

            // ë‚ ì§œ ë³€ê²½ ë¡œê·¸ (ì´ë²¤íŠ¸ ì—¬ë¶€ í™•ì¸)
            const isEventDay = (gameDate.day === 10 || gameDate.day === 20 || gameDate.day === 30);
            addLog(`${gameDate.month}ì›” ${gameDate.day}ì¼ì´ ë˜ì—ˆìŠµë‹ˆë‹¤`, true);
            
            // ì´ë²¤íŠ¸ ë‚ ì´ë©´ ì´ë²¤íŠ¸ ì‹¤í–‰
            if (isEventDay) {
                setTimeout(triggerSpecialEvent, 1000);
            }

            localStorage.setItem('savedGameDate', JSON.stringify(gameDate));
            updateDateUI();
        }
        
        // [ì¶”ê°€] ìŠ¤í˜ì…œ ì´ë²¤íŠ¸ í•¨ìˆ˜
        function triggerSpecialEvent() {
            const season = getSeason(gameDate.month);
            const data = specialEventDB[season];
            if (!data) return;

            // íŒì—… í‘œì‹œ
            const popup = document.getElementById('event-popup');
            document.getElementById('popup-title').innerText = data.title;
            document.getElementById('popup-desc').innerText = "ìŠ¤í˜ì…œ ì—í”¼ì†Œë“œ!";
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 3000);

            // ë¡œê·¸ ë° ëŒ€ì‚¬
            addLog(`<span style="color:#d35400;">[${data.title}]</span> ${data.log}`, false); // ì—¬ê¸° falseëŠ” ë‚ ì§œë¡œê·¸ ì•„ë‹˜ ì˜ë¯¸
            
            // ë§í’ì„  (ë‹¨ìˆœ í‘œì‹œ)
            showBubble('dangbo', data.talk.dangbo, 'high');
            setTimeout(() => showBubble('chung', data.talk.chung, 'low'), 1500);
        }

        function updateDateUI() {
            const seasonKey = getSeason(gameDate.month);
            const season = seasonInfo[seasonKey];

            // [ìˆ˜ì •] í—¤ë” í…ìŠ¤íŠ¸ë¥¼ 'ê¸°ë¡' íƒ€ì´í‹€ê³¼ í•©ì³ì„œ í‘œì‹œ
            const header = document.getElementById('log-header-text');
            // ì˜ˆì‹œ: ğŸŒ¸ ë´„ | 3ì›” 1ì¼ì˜ ê¸°ë¡
            header.innerText = `${season.icon} ${season.name} | ${gameDate.month}ì›” ${gameDate.day}ì¼ì˜ ê¸°ë¡`;

            // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½
            const bg = document.getElementById('game-bg');
            bg.style.backgroundImage = `url('bg/${seasonKey}.jpg')`;
        }


        // ================= UI ë¡œì§ =================
        function toggleInfoPanel() {
            const panel = document.getElementById('info-panel');
            const btn = document.getElementById('mobile-toggle-btn');
            panel.classList.toggle('open');
            btn.innerText = panel.classList.contains('open') ? 'â–²' : 'â–¼';
        }

        function selectCharacter(id) {
            currentUserId = id;
            document.querySelectorAll('.char-select-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id === 'dangbo' ? 'btn-dangbo' : 'btn-chung').classList.add('active');
            renderInfoContent();
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderInfoContent();
        }

        function renderInfoContent() {
            const data = charData[currentUserId];
            const display = document.getElementById('info-display-area');
            let html = '';

            if (currentTab === 'profile') {
                const traitOptions = personalityList.map(p =>
                    `<option value="${p}" ${data.trait === p ? 'selected' : ''}>${p}</option>`
                ).join('');

                // ë°°ê²½ìƒ‰ì— ë”°ë¼ ê¸€ììƒ‰(í°/ê²€) ìë™ ê³„ì‚° (ì´ë¦„í‘œ ê°€ë…ì„±ìš©)
                const nameTagColor = getContrastYIQ(data.color);

                html = `
                    <div style="text-align:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
                        <h2 style="color:${data.color}; margin-bottom:5px;">${data.name}</h2>
                        <span style="background:${data.color}; color:${nameTagColor}; padding:3px 8px; border-radius:10px; font-size:0.8rem;">${data.title}</span>
                    </div>
                    
                    <div class="info-box">
                        <span class="info-label">ğŸ¨ ëŒ€í‘œ ì»¬ëŸ¬ ì„¤ì •</span>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="color" value="${data.color}" onchange="updateCharSetting('color', this.value)" style="width:50px; height:30px; padding:0; border:none; background:none; cursor:pointer;">
                            <span style="font-size:0.8rem; color:#666;">í´ë¦­í•˜ì—¬ ë§í’ì„  ìƒ‰ ë³€ê²½</span>
                        </div>
                    </div>

                    <div class="info-box">
                        <span class="info-label">âš§ ì„±ë³„ ì„¤ì •</span>
                        <select class="custom-select" onchange="updateCharSetting('gender', this.value)">
                            <option value="ë‚¨ì„±" ${data.gender === 'ë‚¨ì„±' ? 'selected' : ''}>ë‚¨ì„± â™‚ï¸</option>
                            <option value="ì—¬ì„±" ${data.gender === 'ì—¬ì„±' ? 'selected' : ''}>ì—¬ì„± â™€ï¸</option>
                        </select>
                    </div>

                    <div class="info-box">
                        <span class="info-label">ğŸ§  ì„±ê²© ì„¤ì •</span>
                        <select class="custom-select" onchange="updateCharSetting('trait', this.value)">
                            ${traitOptions}
                        </select>
                    </div>

                    <button class="save-btn" onclick="saveCharacterSettings()">ğŸ’¾ ì„¤ì • ì €ì¥í•˜ê¸°</button>
                `;
            } else if (currentTab === 'inventory') {
                html = `<div style="padding:5px;">
                        <div style="margin-bottom:10px; font-weight:bold; color:#555;">ì†Œì§€í•˜ê³  ìˆëŠ” ë¬¼í’ˆ</div>
                        ${data.inventory.map(i => `<span class="item-badge">${i}</span>`).join('')}
                        </div>`;
            } else if (currentTab === 'relation') {
                html = `<div style="padding:5px;">
                        ${data.relations.map(r => `
                        <div class="rel-card">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <strong style="font-size:1rem;">To. ${r.target}</strong>
                                <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px;">${r.rel}</span>
                            </div>
                            <div style="font-size:0.9rem; color:#666;">${r.desc}</div>
                        </div>`).join('')}
                        </div>`;
            }
            display.innerHTML = html;
        }

        // [ì¤‘ìš”] ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ì¶”ê°€
        function saveCharacterSettings() {
            // í˜„ì¬ charData ì „ì²´ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            localStorage.setItem('hapsa_char_settings', JSON.stringify(charData));
            alert("ìºë¦­í„° ì„±ë³„ê³¼ ì„±ê²©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        function loadCharacterSettings() {
            const saved = localStorage.getItem('hapsa_char_settings');
            if (saved) {
                const parsed = JSON.parse(saved);
                // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
                Object.keys(parsed).forEach(key => {
                    if (charData[key]) {
                        charData[key].gender = parsed[key].gender;
                        charData[key].trait = parsed[key].trait;
                    }
                });
            }
        }

        // ì„¤ì • ì €ì¥ìš© í—¬í¼ í•¨ìˆ˜
        function updateCharSetting(key, value) {
            if (charData[currentUserId]) {
                charData[currentUserId][key] = value;
                // ì„±ê²©ì´ ë°”ë€Œë©´ ë‹¤ìŒ ëŒ€í™”ë¶€í„° ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.
            }
        }

        function addLog(msg, isSpecial = false) {
            const box = document.getElementById('log-box');
            const d = document.createElement('div');

            // 1. ë‚ ì§œ ë³€ê²½ ì•Œë¦¼ (íŠ¹ìˆ˜ ì²˜ë¦¬)
            if (isSpecial) {
                d.className = 'log-entry log-date';
                d.innerHTML = `<div style="font-weight:bold; font-style:italic; opacity:0.8;">â”€ ${msg} â”€</div>`;
            }
            // 2. ì¼ë°˜ ë¡œê·¸ (ëŒ€í™”, ì‹œìŠ¤í…œ ë“±)
            else {
                // ê¸°ë³¸ í´ë˜ìŠ¤ ì„¤ì •
                d.className = 'log-entry';

                // ë‚´ìš©ì— ë”°ë¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ì¶”ê°€ (í‚¤ì›Œë“œ ë¶„ì„)
                if (msg.includes('[ëŒ€í™”]')) {
                    d.classList.add('log-social'); // íŒŒë€ìƒ‰ ë 
                } else if (msg.includes('[ë…ë°±]')) {
                    d.classList.add('log-system'); // íšŒìƒ‰ ë 
                } else {
                    d.classList.add('log-system'); // ê¸°ë³¸
                }

                // ì‹œê°„ êµ¬í•˜ê¸° (ì´ˆ ë‹¨ìœ„ í¬í•¨)
                const timeStr = new Date().toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // HTML ì¡°ë¦½ (ì‹œê°„ + ë‚´ìš©)
                // ê¸°ì¡´ msgì—ì„œ [ëŒ€í™”] ê°™ì€ íƒœê·¸ë¥¼ ì¢€ ë” ì§„í•˜ê²Œ í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ replace ì‚¬ìš© ê°€ëŠ¥
                const formattedMsg = msg.replace(/\[(.*?)\]/g, '<span style="font-weight:bold;">[$1]</span>');

                d.innerHTML = `<span class="log-time">${timeStr}</span>${formattedMsg}`;
            }

            box.prepend(d);

            // ë¡œê·¸ê°€ 50ê°œ ë„˜ì–´ê°€ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ (ë ‰ ë°©ì§€)
            if (box.children.length > 50) {
                box.lastChild.remove();
            }
        }

        // ================= ìºë¦­í„° ì´ë™ ë° ìƒí˜¸ì‘ìš© =================
        function initCharacters() {
            const stage = document.getElementById('game-stage');
            for (const [id, data] of Object.entries(charData)) {
                const el = document.createElement('div');
                el.className = 'character-sprite';
                el.id = `char-${id}`;
                el.style.left = data.x + '%';
                el.style.top = data.y + '%';
                el.innerHTML = `
                    <div class="bubble" id="bubble-${id}">...</div>
                    <img src="${data.img}" onerror="this.src='https://via.placeholder.com/100?text=${data.name}'">
                    <div style="background:rgba(0,0,0,0.6); color:white; font-size:11px; padding:2px 6px; border-radius:10px; margin-top:5px; font-weight:bold;">${data.name}</div>
                `;
                el.onclick = () => {
                    selectCharacter(id);
                    if (window.innerWidth <= 768) toggleInfoPanel();
                };
                stage.appendChild(el);
                scheduleNextMove(id);
            }
        }

        function moveTo(id, targetX, targetY, callback) {
            const el = document.getElementById(`char-${id}`);
            const data = charData[id];

            const dist = Math.sqrt(Math.pow(targetX - data.x, 2) + Math.pow(targetY - data.y, 2));
            const speedFactor = 0.05;
            const duration = Math.max(1.5, dist * speedFactor);

            el.style.transition = `top ${duration}s linear, left ${duration}s linear`;
            el.classList.add('walking');
            el.style.left = targetX + '%';
            el.style.top = targetY + '%';

            data.x = targetX;
            data.y = targetY;

            setTimeout(() => {
                el.classList.remove('walking');
                if (callback) callback();
            }, duration * 1000);
        }

        // [ìˆ˜ì •] í–‰ë™ ìŠ¤ì¼€ì¤„ë§: ì¿¨íƒ€ì„ ì²´í¬ ì¶”ê°€ (ìœ ë ¹ ë°©ì§€ ë¡œì§ ìœ ì§€)
        function scheduleNextMove(id) {
            if (isInteracting) return; // ìƒí˜¸ì‘ìš© ì¤‘ì´ë©´ ì•„ì˜ˆ ëª…ë ¹ ê±°ë¶€

            const waitTime = Math.random() * 2000 + 1000;

            setTimeout(() => {
                if (isInteracting) {
                    scheduleNextMove(id); // ìƒí˜¸ì‘ìš© ì¤‘ì´ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ í™•ì¸ (ì•ˆì „)
                    return;
                }

                const rand = Math.random();
                // ì¿¨íƒ€ì„ ì²´í¬ (10ì´ˆ)
                const isCooltime = (Date.now() - lastDialogTime) < 10000;

                // 1. ìƒí˜¸ì‘ìš© (ë‹¹ë³´ 40% + ì¿¨íƒ€ì„ ì•„ë‹˜)
                if (id === 'dangbo' && rand < 0.4 && !isCooltime) {
                    triggerInteraction();
                }
                // 2. í˜¼ì£ë§ (30%)
                else if (rand < 0.7) {
                    triggerMonologue(id); 
                    const tx = Math.random() * 80 + 10;
                    const ty = Math.random() * 60 + 20;
                    moveTo(id, tx, ty, () => scheduleNextMove(id));
                }
                // 3. ê·¸ëƒ¥ ì´ë™
                else {
                    const tx = Math.random() * 80 + 10;
                    const ty = Math.random() * 60 + 20;
                    moveTo(id, tx, ty, () => scheduleNextMove(id));
                }
            }, waitTime);
        }

        function triggerInteraction() {
            if (isInteracting) return;
            isInteracting = true;

            const c1 = charData['dangbo'];
            const c2 = charData['chung'];
            const meetX = (c1.x + c2.x) / 2;
            const meetY = (c1.y + c2.y) / 2;

            let arrivedCount = 0;
            const onArrive = () => {
                arrivedCount++;
                if (arrivedCount === 2) startDialog();
            };

            moveTo('dangbo', meetX - 8, meetY, onArrive);
            moveTo('chung', meetX + 8, meetY, onArrive);
        }

        // [ìˆ˜ì •] ëŒ€í™” ì‹œì‘: ì¿¨íƒ€ì„ ì €ì¥ + ë§í’ì„  ìœ„ì¹˜ ì ìš©
        function startDialog() {
            const dangbo = charData['dangbo'];
            const chung = charData['chung'];
            
            let title = "ë„ì‚¬ í˜•ë‹˜";
            if (dangbo.gender === 'ì—¬ì„±' && chung.gender === 'ì—¬ì„±') title = "ë„ì‚¬ ì–¸ë‹ˆ";
            else if (dangbo.gender === 'ë‚¨ì„±' && chung.gender === 'ì—¬ì„±') title = "ë„ì‚¬ ëˆ„ë‹˜";

            const possibleDialogs = [...(dialogDB[dangbo.trait] || []), ...(dialogDB.season[getSeason(gameDate.month)] || [])];
            const scenario = possibleDialogs[Math.floor(Math.random() * possibleDialogs.length)];
            
            // ì¡°ì‚¬ ë³´ì • ì ìš©
            const t1 = fillTitle(scenario.t1, title);
            const t2 = fillTitle(scenario.t2, title);
            const logMsg = fillTitle(scenario.log, title);

            // ë‹¹ë³´ëŠ” High(ì™¼ìª½ìœ„), ì²­ëª…ì€ Low(ì˜¤ë¥¸ìª½ì•„ë˜)
            showBubble('dangbo', t1, 'high');
            
            setTimeout(() => {
                showBubble('chung', t2, 'low');
                addLog(`[ëŒ€í™”] ${logMsg}`);
                
                setTimeout(() => {
                    isInteracting = false;
                    // ëŒ€í™” ëë‚œ ì‹œê°„ ê¸°ë¡ (ì¿¨íƒ€ì„ ì‹œì‘)
                    lastDialogTime = Date.now();
                    localStorage.setItem('savedLastDialogTime', lastDialogTime);

                    scheduleNextMove('dangbo');
                    scheduleNextMove('chung');
                }, 2500);
            }, 2000);
        }

        function triggerMonologue(id) {
            const lines = dialogDB.solo[id];
            if (!lines) return;
            let text = lines[Math.floor(Math.random() * lines.length)];
            
            const dangbo = charData['dangbo'];
            const chung = charData['chung'];
            let title = "í˜•ë‹˜";
            if (dangbo.gender === 'ì—¬ì„±' && chung.gender === 'ì—¬ì„±') title = "ì–¸ë‹ˆ";
            else if (dangbo.gender === 'ë‚¨ì„±' && chung.gender === 'ì—¬ì„±') title = "ëˆ„ë‹˜";
            else if (id === 'dangbo') title = "ë„ì‚¬ í˜•ë‹˜"; // ë‹¹ë³´ê°€ ë§í•  ë•Œ

            // ì¡°ì‚¬ ë³´ì • ì ìš©
            text = fillTitle(text, title);
            showBubble(id, text);
        }

        // [ì¶”ê°€] ì¿¨íƒ€ì„ ê´€ë¦¬
        let lastDialogTime = parseInt(localStorage.getItem('savedLastDialogTime')) || 0;

        // [ì¶”ê°€] ìŠ¤í˜ì…œ ì´ë²¤íŠ¸ ë°ì´í„°
        const specialEventDB = {
            spring: { title: "â­ï¸ ì¢…ë‚¨íŒŒ í˜¼ë‚´ì£¼ê¸°", log: "ì¢…ë‚¨ì˜ ë©ì²­ì´ë“¤ì„ ë‘ë“¤ê²¨ íŒ¨ì¤¬ìŠµë‹ˆë‹¤!", talk: { dangbo: "í˜•ë‹˜ êµ¬ì—­ì—ì„œ ì–¼ì©¡ê±°ë¦¬ë‹¤ë‹ˆ.", chung: "ë‹¤ì‹  ëª» ì˜¤ê²Œ ë‹¤ë¦¬ë¥¼ ë¶„ì§ˆëŸ¬ë†”!" } },
            summer: { title: "â­ï¸ ìˆ˜ë°• ì„œë¦¬", log: "ë‚¨ì˜ ë°­ì—ì„œ ìˆ˜ë°•ì„ ì„œë¦¬í•´ ë¨¹ì—ˆìŠµë‹ˆë‹¤.", talk: { dangbo: "ì—­ì‹œ í›”ì³ ë¨¹ëŠ” ê²Œ ì œë§›ì´ì£ .", chung: "ì•„ì‚­í•˜ë‹ˆ ì¢‹ë„¤!" } },
            autumn: { title: "â­ï¸ ìˆ ë… ë„ì¥ ê¹¨ê¸°", log: "ê°ì”ì˜ ìˆ ì„ ëª¨ì¡°ë¦¬ ë§ˆì…”ë²„ë ¸ìŠµë‹ˆë‹¤.", talk: { dangbo: "í˜•ë‹˜, í•œ ë³‘ ë”?", chung: "ì˜¤ëŠ˜ ë‹¤ ì£½ëŠ” ê±°ì•¼!" } },
            winter: { title: "â­ï¸ ì„¤ì› ë¹„ë¬´", log: "ëˆˆë°­ì—ì„œ ê²©ë ¬í•œ ë¹„ë¬´ë¥¼ í¼ì³¤ìŠµë‹ˆë‹¤.", talk: { dangbo: "ì†ì´ ê³±ì•„ì„œ ì œëŒ€ë¡œ ëª» ë˜ì§€ê² ì†Œ.", chung: "í•‘ê³„ ëŒ€ì§€ ë§ˆë¼!" } }
        };
        
        
        

        // ================= í…Œë§ˆ ë° ì‹¤í–‰ =================
        const themeToggleBtn = document.getElementById('theme-toggle');
        const bodyElement = document.body;

        function applyTheme(theme) {
            if (theme === 'dark') bodyElement.classList.add('dark-theme');
            else bodyElement.classList.remove('dark-theme');
            themeToggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        themeToggleBtn.addEventListener('click', () => {
            bodyElement.classList.toggle('dark-theme');
            applyTheme(bodyElement.classList.contains('dark-theme') ? 'dark' : 'light');
        });
        
        // [ë³µêµ¬] ì¡°ì‚¬ ìë™ ë³´ì • (ì€/ëŠ”, ì´/ê°€ ë“±)
        function fillTitle(text, title) {
            let result = text.replace(/{í˜¸ì¹­}/g, title);
            const regex = new RegExp(`(${title})(ì€|ëŠ”|ì´|ê°€|ì„|ë¥¼|ê³¼|ì™€)`, 'g');
            return result.replace(regex, (match, word, josa) => {
                const lastChar = word.charCodeAt(word.length - 1);
                if (lastChar < 0xAC00 || lastChar > 0xD7A3) return match;
                const hasBatchim = (lastChar - 0xAC00) % 28 > 0;
                if (josa === 'ì€' || josa === 'ëŠ”') return word + (hasBatchim ? 'ì€' : 'ëŠ”');
                if (josa === 'ì´' || josa === 'ê°€') return word + (hasBatchim ? 'ì´' : 'ê°€');
                if (josa === 'ì„' || josa === 'ë¥¼') return word + (hasBatchim ? 'ì„' : 'ë¥¼');
                if (josa === 'ê³¼' || josa === 'ì™€') return word + (hasBatchim ? 'ê³¼' : 'ì™€');
                return match;
            });
        }

        // [ë³µêµ¬] ë°°ê²½ìƒ‰ì— ë”°ë¼ ê¸€ììƒ‰(í°/ê²€) ê²°ì •
        function getContrastYIQ(hexcolor){
            if(!hexcolor) return 'black';
            const r = parseInt(hexcolor.substr(1,2),16);
            const g = parseInt(hexcolor.substr(3,2),16);
            const b = parseInt(hexcolor.substr(5,2),16);
            return (((r*299)+(g*587)+(b*114))/1000) >= 128 ? 'black' : 'white';
        }

        // [ë³µêµ¬] ë§í’ì„  í‘œì‹œ (ìœ„ì¹˜/ìƒ‰ìƒ ì ìš©)
        function showBubble(charId, text, styleType = 'normal') {
            const d = charData[charId];
            const charEl = document.getElementById(`char-${charId}`);
            
            // ê¸°ì¡´ bubble ìš”ì†Œ ì œê±°í•˜ê³  ìƒˆë¡œ ìƒì„± (ìŠ¤íƒ€ì¼ ì¶©ëŒ ë°©ì§€)
            const oldBubble = document.getElementById(`bubble-${charId}`);
            if(oldBubble) oldBubble.remove();

            const bubble = document.createElement('div');
            bubble.id = `bubble-${charId}`;
            bubble.className = 'char-bubble'; // ìƒˆë¡œ ì •ì˜í•œ CSS í´ë˜ìŠ¤
            
            // ìƒ‰ìƒ ì ìš©
            const bgColor = d.color || "#ffffff";
            bubble.style.setProperty('--bubble-bg', bgColor);
            bubble.style.setProperty('--bubble-text', getContrastYIQ(bgColor));

            // ìœ„ì¹˜ í´ë˜ìŠ¤ ì ìš©
            if (styleType === 'high') bubble.classList.add('pos-high');
            else if (styleType === 'low') bubble.classList.add('pos-low');

            bubble.innerText = text;
            charEl.appendChild(bubble);

            // ì• ë‹ˆë©”ì´ì…˜
            requestAnimationFrame(() => bubble.classList.add('show'));
            setTimeout(() => {
                bubble.classList.remove('show');
                setTimeout(() => bubble.remove(), 300);
            }, 3500);
        }

        window.onload = () => {
            loadCharacterSettings(); // [ì¶”ê°€] ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            renderInfoContent();
            initCharacters();
            updateDateUI();
            updateTime();
        };
    </script>
</body></html>